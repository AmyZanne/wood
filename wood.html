<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <meta name="generator" content="pandoc" />
  <title></title>
  <style type="text/css">code{white-space: pre;}</style>
  <style type="text/css">
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; background-color: #f8f8f8; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
pre, code { background-color: #f8f8f8; }
code > span.kw { color: #204a87; font-weight: bold; }
code > span.dt { color: #204a87; }
code > span.dv { color: #0000cf; }
code > span.bn { color: #0000cf; }
code > span.fl { color: #0000cf; }
code > span.ch { color: #4e9a06; }
code > span.st { color: #4e9a06; }
code > span.co { color: #8f5902; font-style: italic; }
code > span.ot { color: #8f5902; }
code > span.al { color: #ef2929; }
code > span.fu { color: #000000; }
code > span.er { font-weight: bold; }
  </style>
</head>
<body>
<p><code>r library(diversitree)</code></p>
<pre><code>## Loading required package: deSolve
## Loading required package: ape
## Loading required package: subplex
## Loading required package: methods
## Loading required package: Rcpp</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Fetch the Zanne et al data from Dryad</span>
<span class="kw">source</span>(<span class="st">&quot;data/zae/download.R&quot;</span>, <span class="dt">chdir =</span> <span class="ot">TRUE</span>)</code></pre>
<pre><code>## Warning: package &#39;assertthat&#39; was built under R version 3.0.2</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">source</span>(<span class="st">&quot;wood-functions.R&quot;</span>)</code></pre>
<p>We're going to put some partly processed data here.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">dir.create</span>(<span class="st">&quot;output&quot;</span>, <span class="ot">FALSE</span>)</code></pre>
<p>Colours used throughout:</p>
<pre class="sourceCode r"><code class="sourceCode r">cols.methods &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dt">binomial=</span><span class="st">&quot;#a63813&quot;</span>,
                  <span class="dt">hypergeometric=</span><span class="st">&quot;#4d697f&quot;</span>)
cols.tree &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dt">Monilophytes=</span><span class="st">&quot;#a63813&quot;</span>,
               <span class="dt">Gymnosperms=</span><span class="st">&quot;#21313b&quot;</span>,
               <span class="dt">BasalAngiosperms=</span><span class="st">&quot;#eeb911&quot;</span>,
               <span class="dt">Monocots=</span><span class="st">&quot;#204d14&quot;</span>,
               <span class="dt">Eudicots=</span><span class="st">&quot;#4d697f&quot;</span>,
               <span class="dt">Rest=</span><span class="st">&quot;gray15&quot;</span>)
cols.woody &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dt">Woody=</span><span class="st">&quot;#533d0c&quot;</span>,
                <span class="dt">Herbaceous=</span><span class="st">&quot;#799321&quot;</span>)
cols.woody &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dt">Woody=</span><span class="st">&quot;black&quot;</span>,
                <span class="dt">Herbaceous=</span><span class="st">&quot;white&quot;</span>)
cols.shading &lt;-<span class="st"> &quot;#eeb911&quot;</span>
cols.tropical &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dt">tropical=</span><span class="st">&quot;#ea7518&quot;</span>,
                   <span class="dt">temperate=</span><span class="st">&quot;#62a184&quot;</span>)</code></pre>
<p>The 'load.woodiness.data.genus' function hides a reasonable amount of data cleaning required to load the data. This mostly involves matching the woodiness data set from Zanne et al. to our species list (derived from The Plant List), cleaning up synonomies, and then collapsing down to genus.</p>
<pre class="sourceCode r"><code class="sourceCode r">##</code></pre>
<p>The final object has columns * genus, family, order -- taxonomic information * W, V, H -- number of species scored as woody, variable, herbaceous (respectively) * N -- number of species in the genus * K -- number of species with known state, after dropping all &quot;variable&quot; species * p -- fraction of known species that are woody, after dropping all &quot;variable&quot; species</p>
<pre class="sourceCode r"><code class="sourceCode r">dat.g &lt;-<span class="st"> </span><span class="kw">load.woodiness.data.genus</span>()</code></pre>
<pre><code>## Dropping 9388 species not in Plant List
## 90.1% of species have a valid name; resolving 3925 species
## After synonym correction, 1448 duplicated entries
## Final set: 14680 genera, 7303 with data, 37494 species known</code></pre>
<p>Here is the simulator.</p>
<p>For each genus:</p>
<p>A. If the genus has a valid fraction of species (i.e. K &gt; 0 so p is defined), then sample the number of species that are woody from either - the binomial distribution (strong prior; assuming known species were sampled with replacement from the pool of species); or - the hypergeometric distribution (weak prior; assuming that known species were sampled without replacement from the pool of species).</p>
<p>B. If the genus has no valid fraction of species (i.e., K == 0 so p is undefined), then sample from the emperical distribution of per-genus fractions. We're going to feed data into this by taxonomic order, so this will come from the per-order distribution.</p>
<pre class="sourceCode r"><code class="sourceCode r">sim &lt;-<span class="st"> </span>function(x, nrep, <span class="dt">with.replacement=</span><span class="ot">TRUE</span>, <span class="dt">p=</span><span class="dv">1</span>/<span class="dv">20</span>) {
  ## First, focus on cases where we have a valid estimate of the
  ## fraction of species that are woody (i.e., at least one known
  ## species).
  ok &lt;-<span class="st"> </span>!<span class="kw">is.na</span>(x$p)

  w &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="ot">NA</span>, <span class="kw">nrow</span>(x), nrep)

  ## A: genera with any known species
  if (with.replacement)
    w[ok,] &lt;-<span class="st"> </span>x$W[ok] +<span class="st"> </span><span class="kw">rbinom</span>(<span class="kw">sum</span>(ok), x$N[ok]-x$K[ok], x$W[ok]/x$K[ok])
  else
    w[ok,] &lt;-<span class="st"> </span><span class="kw">t</span>(<span class="kw">sapply</span>(<span class="kw">which</span>(ok), function(i)
                       <span class="kw">rhyper2</span>(nrep, x$H[i], x$W[i], x$N[i])))

  ## B: genera with no known species
  n.unk &lt;-<span class="st"> </span><span class="kw">sum</span>(!ok)
  w[!ok,] &lt;-<span class="st"> </span><span class="kw">apply</span>(w[ok,,<span class="dt">drop=</span><span class="ot">FALSE</span>] /<span class="st"> </span>x$N[ok], <span class="dv">2</span>, function(y)
                   <span class="kw">rbinom</span>(n.unk, x$N[!ok], <span class="kw">quantile</span>(y, <span class="kw">runif</span>(n.unk))))
  
  <span class="kw">rownames</span>(w) &lt;-<span class="st"> </span>x$genus

  <span class="kw">summarise.sim</span>(w, x[<span class="kw">c</span>(<span class="st">&quot;order&quot;</span>, <span class="st">&quot;family&quot;</span>, <span class="st">&quot;genus&quot;</span>,
                       <span class="st">&quot;W&quot;</span>, <span class="st">&quot;V&quot;</span>, <span class="st">&quot;H&quot;</span>, <span class="st">&quot;N&quot;</span>, <span class="st">&quot;K&quot;</span>)])
}</code></pre>
<p>This collects up the results at different taxonomic levels.</p>
<pre class="sourceCode r"><code class="sourceCode r">summarise &lt;-<span class="st"> </span>function(x, <span class="dt">p=</span><span class="dv">1</span>/<span class="dv">20</span>)
  <span class="kw">structure</span>(<span class="kw">c</span>(<span class="kw">mean</span>(x), <span class="kw">quantile</span>(x, <span class="kw">c</span>(p/<span class="dv">2</span>, <span class="dv">1</span>-p/<span class="dv">2</span>))),
            <span class="dt">names=</span><span class="kw">c</span>(<span class="st">&quot;mean&quot;</span>, <span class="st">&quot;lower&quot;</span>, <span class="st">&quot;upper&quot;</span>))
summarise.sim &lt;-<span class="st"> </span>function(w, info) {
  order &lt;-<span class="st"> </span>info$order[[<span class="dv">1</span>]]

  info.cols &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;W&quot;</span>, <span class="st">&quot;V&quot;</span>, <span class="st">&quot;H&quot;</span>, <span class="st">&quot;N&quot;</span>, <span class="st">&quot;K&quot;</span>)

  ## Genus is easy;
  w.g &lt;-<span class="st"> </span><span class="kw">cbind</span>(info, <span class="kw">t</span>(<span class="kw">apply</span>(w, <span class="dv">1</span>, summarise)))

  ## Family is a pain:
  w.f &lt;-<span class="st"> </span><span class="kw">do.call</span>(rbind,
                 <span class="kw">lapply</span>(<span class="kw">split</span>(<span class="kw">as.data.frame</span>(w), info$family), colSums))
  w.f &lt;-<span class="st"> </span><span class="kw">t</span>(<span class="kw">apply</span>(w.f, <span class="dv">1</span>, summarise))
  w.f &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">order=</span>order,
                    <span class="kw">aggregate</span>(info[info.cols], info[<span class="st">&quot;family&quot;</span>], sum),
                    w.f, <span class="dt">stringsAsFactors=</span><span class="ot">TRUE</span>)
  <span class="kw">rownames</span>(w.f) &lt;-<span class="st"> </span><span class="ot">NULL</span>
  
  ## Order is easy; we are guaranteed to have just one order here, so:
  w.o &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">order=</span>order,
                    <span class="kw">as.data.frame</span>(<span class="kw">t</span>(<span class="kw">colSums</span>(info[info.cols]))),
                    <span class="kw">t</span>(<span class="kw">summarise</span>(<span class="kw">colSums</span>(w))), <span class="dt">stringsAsFactors=</span><span class="ot">FALSE</span>)

  ret &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">genus=</span>w.g, <span class="dt">family=</span>w.f, <span class="dt">order=</span>w.o)
  <span class="kw">attr</span>(ret, <span class="st">&quot;total&quot;</span>) &lt;-<span class="st"> </span><span class="kw">colSums</span>(w)
  ret
}

rhyper2 &lt;-<span class="st"> </span>function(nn, s0, s1, xn, <span class="dt">fraction=</span><span class="ot">FALSE</span>) {
  x1 &lt;-<span class="st"> </span><span class="kw">seq</span>(s1, xn -<span class="st"> </span>s0)
  x0 &lt;-<span class="st"> </span>xn -<span class="st"> </span>x1
  p1 &lt;-<span class="st"> </span><span class="kw">dhyper</span>(s1, x1, x0, s0+s1)
  p1 &lt;-<span class="st"> </span>p1 /<span class="st"> </span><span class="kw">sum</span>(p1)
  x1[<span class="kw">sample</span>(<span class="kw">length</span>(p1), nn, <span class="ot">TRUE</span>, p1)]
}

do.simulation &lt;-<span class="st"> </span>function(dat.g, nrep, with.replacement) {
  f &lt;-<span class="st"> </span>function(level) {
    ret &lt;-<span class="st"> </span><span class="kw">do.call</span>(rbind, <span class="kw">lapply</span>(res, <span class="st">&quot;[[&quot;</span>, level))
    <span class="kw">rownames</span>(ret) &lt;-<span class="st"> </span><span class="ot">NULL</span>
    ret[<span class="kw">c</span>(<span class="st">&quot;p.mean&quot;</span>, <span class="st">&quot;p.lower&quot;</span>, <span class="st">&quot;p.upper&quot;</span>)] &lt;-
<span class="st">      </span>ret[<span class="kw">c</span>(<span class="st">&quot;mean&quot;</span>, <span class="st">&quot;lower&quot;</span>, <span class="st">&quot;upper&quot;</span>)] /<span class="st"> </span>ret[[<span class="st">&quot;N&quot;</span>]]
    ret
  }

  res &lt;-<span class="st"> </span><span class="kw">lapply</span>(<span class="kw">split</span>(dat.g, dat.g$order),
                sim, nrep, with.replacement)
  total &lt;-<span class="st"> </span><span class="kw">rowSums</span>(<span class="kw">sapply</span>(res, attr, <span class="st">&quot;total&quot;</span>))
  overall &lt;-<span class="st"> </span><span class="kw">summarise</span>(total)
  overall.p &lt;-<span class="st"> </span>overall /<span class="st"> </span><span class="kw">sum</span>(dat.g$N)

  <span class="kw">list</span>(<span class="dt">genus=</span><span class="kw">f</span>(<span class="st">&quot;genus&quot;</span>), <span class="dt">family=</span><span class="kw">f</span>(<span class="st">&quot;family&quot;</span>), <span class="dt">order=</span><span class="kw">f</span>(<span class="st">&quot;order&quot;</span>),
       <span class="dt">overall=</span>overall, <span class="dt">overall.p=</span>overall.p, <span class="dt">total=</span>total)
}

<span class="kw">set.seed</span>(<span class="dv">1</span>)
res.b &lt;-<span class="st"> </span><span class="kw">do.simulation</span>(dat.g, <span class="dv">1000</span>, <span class="ot">TRUE</span>)  <span class="co"># binomial - with replacement</span>
res.h &lt;-<span class="st"> </span><span class="kw">do.simulation</span>(dat.g, <span class="dv">1000</span>, <span class="ot">FALSE</span>) <span class="co"># hypergeometric - without</span>

fig.distribution.raw &lt;-<span class="st"> </span>function(res.b, res.h) {
  n.spp &lt;-<span class="st"> </span><span class="kw">sum</span>(res.b$order$N)
  p.b &lt;-<span class="st"> </span>res.b$total /<span class="st"> </span>n.spp *<span class="st"> </span><span class="dv">100</span>
  p.h &lt;-<span class="st"> </span>res.h$total /<span class="st"> </span>n.spp *<span class="st"> </span><span class="dv">100</span>
  
  r &lt;-<span class="st"> </span><span class="kw">range</span>(p.b, p.h)
  br &lt;-<span class="st"> </span><span class="kw">seq</span>(r[<span class="dv">1</span>], r[<span class="dv">2</span>], <span class="dt">length.out=</span><span class="dv">30</span>)

  h.b &lt;-<span class="st"> </span><span class="kw">hist</span>(p.b, br, <span class="dt">plot=</span><span class="ot">FALSE</span>)
  h.h &lt;-<span class="st"> </span><span class="kw">hist</span>(p.h, br, <span class="dt">plot=</span><span class="ot">FALSE</span>)

  xlim &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">42</span>, <span class="dv">50</span>)
  ylim &lt;-<span class="st"> </span><span class="kw">range</span>(h.b$density, h.h$density)

  cols &lt;-<span class="st"> </span>cols.methods
  
  op &lt;-<span class="st"> </span><span class="kw">par</span>(<span class="dt">mar=</span><span class="kw">c</span>(<span class="fl">4.1</span>, <span class="fl">4.1</span>, .<span class="dv">5</span>, .<span class="dv">5</span>))
  <span class="kw">on.exit</span>(<span class="kw">par</span>(op))
  <span class="kw">plot</span>(h.b, <span class="dt">col=</span>cols[<span class="dv">1</span>], <span class="dt">xlim=</span>xlim, <span class="dt">ylim=</span>ylim, <span class="dt">freq=</span><span class="ot">FALSE</span>, <span class="dt">yaxt=</span><span class="st">&quot;n&quot;</span>,
       <span class="dt">ylab=</span><span class="st">&quot;&quot;</span>,
       <span class="dt">xlab=</span><span class="st">&quot;Percentage of woody species among all vascular plants&quot;</span>,
       <span class="dt">main=</span><span class="st">&quot;&quot;</span>)
  <span class="kw">box</span>(<span class="dt">bty=</span><span class="st">&quot;l&quot;</span>)
  <span class="kw">lines</span>(h.h, <span class="dt">col=</span>cols[<span class="dv">2</span>], <span class="dt">freq=</span><span class="ot">FALSE</span>)
  <span class="kw">mtext</span>(<span class="st">&quot;Probability density&quot;</span>, <span class="dv">2</span>, <span class="dt">line=</span>.<span class="dv">5</span>)
}</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">fig.distribution.raw</span>(res.b, res.h)</code></pre>
<div class="figure">
<img src="figure/distribution_raw.png" alt="Distribution of simulated woodiness percentage" /><p class="caption">Distribution of simulated woodiness percentage</p>
</div>
<p>Try and get some extreme results; recode the results with more inclusive criteria for being either woody or herbaceous:</p>
<pre class="sourceCode r"><code class="sourceCode r">dat.g.w &lt;-<span class="st"> </span><span class="kw">load.woodiness.data.genus</span>(<span class="dt">extreme=</span><span class="st">&quot;woody&quot;</span>)</code></pre>
<pre><code>## Final set: 14680 genera, 7455 with data, 37961 species known</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">dat.g.h &lt;-<span class="st"> </span><span class="kw">load.woodiness.data.genus</span>(<span class="dt">extreme=</span><span class="st">&quot;herbaceous&quot;</span>)</code></pre>
<pre><code>## Final set: 14680 genera, 7455 with data, 37961 species known</code></pre>
<p>Redo the simulations with these more extreme codings to incorporate these errors into the simulations:</p>
<pre class="sourceCode r"><code class="sourceCode r">res.b.w &lt;-<span class="st"> </span><span class="kw">do.simulation</span>(dat.g.w, <span class="dv">1000</span>, <span class="ot">TRUE</span>)  <span class="co"># binomial       &amp; woody</span>
res.h.w &lt;-<span class="st"> </span><span class="kw">do.simulation</span>(dat.g.w, <span class="dv">1000</span>, <span class="ot">FALSE</span>) <span class="co"># hypergeometric &amp; woody</span>
res.b.h &lt;-<span class="st"> </span><span class="kw">do.simulation</span>(dat.g.h, <span class="dv">1000</span>, <span class="ot">TRUE</span>)  <span class="co"># binomial       &amp; herby</span>
res.h.h &lt;-<span class="st"> </span><span class="kw">do.simulation</span>(dat.g.h, <span class="dv">1000</span>, <span class="ot">FALSE</span>) <span class="co"># hypergeometric &amp; herby</span>

fig.distribution.raw.errors &lt;-<span class="st"> </span>function(res.b,   res.h,
                                        res.b.w, res.h.w,
                                        res.b.h, res.h.h) {
  n.spp &lt;-<span class="st"> </span><span class="kw">sum</span>(res.b$order$N)
  res &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">b  =</span>res.b,   <span class="dt">h  =</span>res.h,
              <span class="dt">b.w=</span>res.b.w, <span class="dt">h.w=</span>res.h.w,
              <span class="dt">b.h=</span>res.b.h, <span class="dt">h.h=</span>res.h.h)
  p &lt;-<span class="st"> </span><span class="kw">lapply</span>(res, function(x) x$total /<span class="st"> </span>n.spp *<span class="st"> </span><span class="dv">100</span>)

  r &lt;-<span class="st"> </span><span class="kw">range</span>(<span class="kw">unlist</span>(p))
  br &lt;-<span class="st"> </span><span class="kw">seq</span>(r[<span class="dv">1</span>], r[<span class="dv">2</span>], <span class="dt">length.out=</span><span class="dv">30</span>)

  h &lt;-<span class="st"> </span><span class="kw">lapply</span>(p, hist, br, <span class="dt">plot=</span><span class="ot">FALSE</span>)

  xlim &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">42</span>, <span class="dv">50</span>)
  ylim &lt;-<span class="st"> </span><span class="kw">range</span>(<span class="kw">unlist</span>(<span class="kw">lapply</span>(h, function(x) x$density)))

  cols &lt;-<span class="st"> </span>cols.methods
  cols.fill &lt;-<span class="st"> </span><span class="kw">mix</span>(cols, <span class="st">&quot;white&quot;</span>, <span class="fl">0.5</span>)

  op &lt;-<span class="st"> </span><span class="kw">par</span>(<span class="dt">mar=</span><span class="kw">c</span>(<span class="fl">1.1</span>, <span class="fl">0.5</span>, .<span class="dv">5</span>, .<span class="dv">5</span>), <span class="dt">mfrow=</span><span class="kw">c</span>(<span class="dv">2</span>, <span class="dv">1</span>), <span class="dt">oma=</span><span class="kw">c</span>(<span class="fl">3.1</span>, <span class="dv">2</span>, <span class="dv">0</span>, <span class="dv">0</span>))
  <span class="kw">on.exit</span>(<span class="kw">par</span>(op))
  <span class="kw">plot</span>(<span class="ot">NA</span>, <span class="dt">xlim=</span>xlim, <span class="dt">ylim=</span>ylim, <span class="dt">xaxt=</span><span class="st">&quot;n&quot;</span>, <span class="dt">yaxt=</span><span class="st">&quot;n&quot;</span>, <span class="dt">bty=</span><span class="st">&quot;l&quot;</span>,
       <span class="dt">xlab=</span><span class="st">&quot;&quot;</span>, <span class="dt">ylab=</span><span class="st">&quot;&quot;</span>, <span class="dt">main=</span><span class="st">&quot;&quot;</span>)
  <span class="kw">axis</span>(<span class="dv">1</span>, <span class="dt">labels=</span><span class="ot">FALSE</span>)
  for (i in <span class="kw">c</span>(<span class="dv">3</span>, <span class="dv">5</span>))
    <span class="kw">hist.fill</span>(h[[i]], <span class="dt">border=</span>cols[[<span class="dv">1</span>]], <span class="dt">col=</span>cols.fill[[<span class="dv">1</span>]])
  <span class="kw">lines</span>(h[[<span class="st">&quot;b&quot;</span>]], <span class="dt">col=</span>cols[<span class="dv">1</span>], <span class="dt">freq=</span><span class="ot">FALSE</span>)
  <span class="kw">label</span>(.<span class="dv">02</span>, .<span class="dv">96</span>, <span class="dv">1</span>)

  <span class="kw">plot</span>(<span class="ot">NA</span>, <span class="dt">xlim=</span>xlim, <span class="dt">ylim=</span>ylim, <span class="dt">xaxt=</span><span class="st">&quot;n&quot;</span>, <span class="dt">yaxt=</span><span class="st">&quot;n&quot;</span>, <span class="dt">bty=</span><span class="st">&quot;l&quot;</span>,
       <span class="dt">xlab=</span><span class="st">&quot;&quot;</span>, <span class="dt">ylab=</span><span class="st">&quot;&quot;</span>, <span class="dt">main=</span><span class="st">&quot;&quot;</span>)
  <span class="kw">axis</span>(<span class="dv">1</span>, <span class="dt">labels=</span><span class="ot">TRUE</span>)
  for (i in <span class="kw">c</span>(<span class="dv">4</span>, <span class="dv">6</span>))
    <span class="kw">hist.fill</span>(h[[i]], <span class="dt">border=</span>cols[[<span class="dv">2</span>]], <span class="dt">col=</span>cols.fill[[<span class="dv">2</span>]])
  <span class="kw">lines</span>(h[[<span class="st">&quot;h&quot;</span>]], <span class="dt">col=</span>cols[<span class="dv">2</span>], <span class="dt">freq=</span><span class="ot">FALSE</span>)
  <span class="kw">mtext</span>(<span class="st">&quot;Probability density&quot;</span>, <span class="dv">2</span>, <span class="dt">line=</span>.<span class="dv">5</span>, <span class="dt">outer=</span><span class="ot">TRUE</span>)
  <span class="kw">mtext</span>(<span class="st">&quot;Percentage of woody species among all vascular plants&quot;</span>, <span class="dv">1</span>,
        <span class="dt">line=</span><span class="fl">2.5</span>, <span class="dt">xpd=</span><span class="ot">NA</span>)
  <span class="kw">label</span>(.<span class="dv">02</span>, .<span class="dv">96</span>, <span class="dv">2</span>)
}</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">fig.distribution.raw.errors</span>(res.b, res.h, res.b.w, res.h.w, res.b.h, res.h.h)</code></pre>
<div class="figure">
<img src="figure/distribution_errors.png" alt="Effect of recoding on woodiness estimates" /><p class="caption">Effect of recoding on woodiness estimates</p>
</div>
<p>Now, look at the distributions of woodiness among families:</p>
<pre class="sourceCode r"><code class="sourceCode r">fig.fraction.by.group &lt;-<span class="st"> </span>function(res.b, res.h, dat.g, <span class="dt">level=</span><span class="st">&quot;genus&quot;</span>) {
  op &lt;-<span class="st"> </span><span class="kw">par</span>(<span class="dt">mfrow=</span><span class="kw">c</span>(<span class="dv">2</span>, <span class="dv">1</span>), <span class="dt">mar=</span><span class="kw">c</span>(<span class="dv">2</span>, <span class="dv">2</span>, .<span class="dv">5</span>, .<span class="dv">5</span>), <span class="dt">oma=</span><span class="kw">c</span>(<span class="dv">2</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>))
  <span class="kw">on.exit</span>(<span class="kw">par</span>(op))
  lwd &lt;-<span class="st"> </span><span class="fl">1.5</span>

  n.br &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dt">genus=</span><span class="dv">50</span>, <span class="dt">family=</span><span class="dv">40</span>, <span class="dt">order=</span><span class="dv">30</span>)[[level]]
  tmp &lt;-<span class="st"> </span><span class="kw">aggregate</span>(dat.g[<span class="kw">c</span>(<span class="st">&quot;W&quot;</span>, <span class="st">&quot;K&quot;</span>)], dat.g[level], sum)
  tmp &lt;-<span class="st"> </span>tmp[tmp$K &gt;=<span class="st"> </span><span class="dv">10</span>,] <span class="co"># at least 10 records per group</span>
  h &lt;-<span class="st"> </span><span class="kw">hist</span>(<span class="dv">100</span> *<span class="st"> </span>tmp$W /<span class="st"> </span>tmp$K, n.br, <span class="dt">plot=</span><span class="ot">FALSE</span>)

  <span class="kw">plot</span>(<span class="ot">NA</span>, <span class="dt">xlim=</span><span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">100</span>), <span class="dt">ylim=</span><span class="kw">range</span>(<span class="dv">0</span>, h$density),
       <span class="dt">xaxt=</span><span class="st">&quot;n&quot;</span>, <span class="dt">yaxt=</span><span class="st">&quot;n&quot;</span>, <span class="dt">bty=</span><span class="st">&quot;l&quot;</span>, <span class="dt">xlab=</span><span class="st">&quot;&quot;</span>, <span class="dt">ylab=</span><span class="st">&quot;&quot;</span>)
  <span class="kw">mtext</span>(<span class="st">&quot;Probability density&quot;</span>, <span class="dv">2</span>, <span class="dt">line=</span>.<span class="dv">5</span>)
  <span class="kw">axis</span>(<span class="dv">1</span>, <span class="dt">tick=</span><span class="ot">TRUE</span>, <span class="dt">label=</span><span class="ot">FALSE</span>)
  <span class="kw">label</span>(.<span class="dv">02</span>, .<span class="dv">96</span>, <span class="dv">1</span>)
  <span class="kw">hist.outline</span>(h, <span class="dt">col=</span><span class="st">&quot;black&quot;</span>, <span class="dt">lwd=</span>lwd)
  
  cols &lt;-<span class="st"> </span>cols.methods

  x.b &lt;-<span class="st"> </span>res.b[[level]]
  x.h &lt;-<span class="st"> </span>res.h[[level]]
  h.b &lt;-<span class="st"> </span><span class="kw">hist</span>(<span class="dv">100</span>*x.b$p.mean[x.b$N &gt;=<span class="st"> </span><span class="dv">10</span>], <span class="dt">n=</span>n.br, <span class="dt">plot=</span><span class="ot">FALSE</span>)
  h.h &lt;-<span class="st"> </span><span class="kw">hist</span>(<span class="dv">100</span>*x.h$p.mean[x.h$N &gt;=<span class="st"> </span><span class="dv">10</span>], <span class="dt">n=</span>n.br, <span class="dt">plot=</span><span class="ot">FALSE</span>)
  ylim &lt;-<span class="st"> </span><span class="kw">range</span>(h.b$density, h.h$density)
  <span class="kw">plot</span>(<span class="ot">NA</span>, <span class="dt">xlim=</span><span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">100</span>), <span class="dt">ylim=</span>ylim,
       <span class="dt">xlab=</span><span class="st">&quot;&quot;</span>, <span class="dt">ylab=</span><span class="st">&quot;&quot;</span>, <span class="dt">yaxt=</span><span class="st">&quot;n&quot;</span>, <span class="dt">bty=</span><span class="st">&quot;n&quot;</span>, <span class="dt">bty=</span><span class="st">&quot;l&quot;</span>)
  <span class="kw">mtext</span>(<span class="st">&quot;Probability density&quot;</span>, <span class="dv">2</span>, <span class="dt">line=</span>.<span class="dv">5</span>)
  <span class="kw">mtext</span>(<span class="kw">paste</span>(<span class="st">&quot;Percentage of woody species in&quot;</span>, level), <span class="dv">1</span>, <span class="dt">outer=</span><span class="ot">TRUE</span>,
        <span class="dt">line=</span>.<span class="dv">5</span>)

  <span class="kw">hist.outline</span>(h.b, <span class="dt">col=</span>cols[<span class="dv">1</span>], <span class="dt">lwd=</span>lwd)
  <span class="kw">hist.outline</span>(h.h, <span class="dt">col=</span>cols[<span class="dv">2</span>], <span class="dt">lwd=</span>lwd)
  
  <span class="kw">legend</span>(<span class="st">&quot;topleft&quot;</span>, <span class="kw">c</span>(<span class="st">&quot;Strong prior (binomial)&quot;</span>,
                      <span class="st">&quot;Weak prior (hypergeometric)&quot;</span>),
         <span class="dt">col=</span>cols, <span class="dt">lty=</span><span class="dv">1</span>, <span class="dt">bty=</span><span class="st">&quot;n&quot;</span>, <span class="dt">cex=</span>.<span class="dv">85</span>, <span class="dt">inset=</span><span class="kw">c</span>(.<span class="dv">1</span>, <span class="dv">0</span>), <span class="dt">lwd=</span>lwd)
  <span class="kw">label</span>(.<span class="dv">02</span>, .<span class="dv">96</span>, <span class="dv">2</span>)
}</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">fig.fraction.by.group</span>(res.b, res.h, dat.g, <span class="st">&quot;genus&quot;</span>)</code></pre>
<div class="figure">
<img src="figure/fraction_by_genus.png" alt="Fraction of woodiness by genus" /><p class="caption">Fraction of woodiness by genus</p>
</div>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">fig.fraction.by.group</span>(res.b, res.h, dat.g, <span class="st">&quot;family&quot;</span>)</code></pre>
<div class="figure">
<img src="figure/fraction_by_family.png" alt="Fraction of woodiness by family" /><p class="caption">Fraction of woodiness by family</p>
</div>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">fig.fraction.by.group</span>(res.b, res.h, dat.g, <span class="st">&quot;order&quot;</span>)</code></pre>
<div class="figure">
<img src="figure/fraction_by_order.png" alt="Fraction of woodiness by order" /><p class="caption">Fraction of woodiness by order</p>
</div>
<p>Phylogeny at the level of order</p>
<pre class="sourceCode r"><code class="sourceCode r">phy.o &lt;-<span class="st"> </span><span class="kw">build.order.tree</span>(dat.g)</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">fig.fraction.on.phylogeny</span>(phy.o, res.b)</code></pre>
<div class="figure">
<img src="figure/fraction_phy_binomial.png" alt="Woodiness percentage by order" /><p class="caption">Woodiness percentage by order</p>
</div>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">fig.fraction.on.phylogeny</span>(phy.o, res.h)</code></pre>
<div class="figure">
<img src="figure/fraction_phy_hypergeometric.png" alt="Woodiness percentage by order" /><p class="caption">Woodiness percentage by order</p>
</div>
<h1 id="survey">Survey:</h1>
<p>If you want to redo the lat/long calculations, this is the function to run: <code>build.country.list()</code> before running <code>load.survey()</code> below. This downloads some files from GBIF and extracts country-level lat/long values from it to rebuild <code>geo/country_coords.csv</code>. This file is already available in the repository, so this will rarely be needed. It is how this file was generated, however.</p>
<pre class="sourceCode r"><code class="sourceCode r">d.survey &lt;-<span class="st"> </span><span class="kw">load.survey</span>()</code></pre>
<p>Convert estimates to normal using logit transformation:</p>
<pre class="sourceCode r"><code class="sourceCode r">d.survey$Estimate.logit &lt;-<span class="st"> </span>boot::<span class="kw">logit</span>(d.survey$Estimate /<span class="st"> </span><span class="dv">100</span>)</code></pre>
<p>Model with training and familiarity as factors:</p>
<pre class="sourceCode r"><code class="sourceCode r">res &lt;-<span class="st"> </span><span class="kw">lm</span>(Estimate.logit ~<span class="st"> </span>Training +<span class="st"> </span>Familiarity, d.survey)
<span class="kw">summary</span>(res)</code></pre>
<pre><code>## 
## Call:
## lm(formula = Estimate.logit ~ Training + Familiarity, data = d.survey)
## 
## Residuals:
##    Min     1Q Median     3Q    Max 
## -3.816 -0.495  0.016  0.607  2.976 
## 
## Coefficients:
##               Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept)    -1.0674     0.1105   -9.66  &lt; 2e-16 ***
## Training.L      0.3632     0.2305    1.58  0.11634    
## Training.Q      0.0544     0.1733    0.31  0.75397    
## Training.C      0.2069     0.1588    1.30  0.19370    
## Training^4     -0.3203     0.1656   -1.93  0.05415 .  
## Familiarity.L  -1.0419     0.3076   -3.39  0.00081 ***
## Familiarity.Q  -0.2420     0.2109   -1.15  0.25227    
## Familiarity.C  -0.0660     0.1326   -0.50  0.61892    
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 0.982 on 277 degrees of freedom
##   (7 observations deleted due to missingness)
## Multiple R-squared:  0.0656, Adjusted R-squared:  0.042 
## F-statistic: 2.78 on 7 and 277 DF,  p-value: 0.00826</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">anova</span>(res)</code></pre>
<pre><code>## Analysis of Variance Table
## 
## Response: Estimate.logit
##              Df Sum Sq Mean Sq F value Pr(&gt;F)   
## Training      4    5.8    1.46    1.51 0.1990   
## Familiarity   3   12.9    4.32    4.47 0.0044 **
## Residuals   277  267.3    0.97                  
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</code></pre>
<p>Regression against |latitude|:</p>
<pre class="sourceCode r"><code class="sourceCode r">res.lat &lt;-<span class="st"> </span><span class="kw">lm</span>(Estimate.logit ~<span class="st"> </span><span class="kw">abs</span>(Lat), d.survey)
<span class="kw">anova</span>(res.lat)</code></pre>
<pre><code>## Analysis of Variance Table
## 
## Response: Estimate.logit
##            Df Sum Sq Mean Sq F value Pr(&gt;F)  
## abs(Lat)    1      5    4.96    5.12  0.024 *
## Residuals 280    271    0.97                 
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">summary</span>(res.lat)</code></pre>
<pre><code>## 
## Call:
## lm(formula = Estimate.logit ~ abs(Lat), data = d.survey)
## 
## Residuals:
##    Min     1Q Median     3Q    Max 
## -3.854 -0.588  0.124  0.566  3.168 
## 
## Coefficients:
##             Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept) -0.65407    0.13105   -4.99  1.1e-06 ***
## abs(Lat)    -0.00804    0.00355   -2.26    0.024 *  
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 0.985 on 280 degrees of freedom
##   (10 observations deleted due to missingness)
## Multiple R-squared:  0.018,  Adjusted R-squared:  0.0144 
## F-statistic: 5.12 on 1 and 280 DF,  p-value: 0.0244</code></pre>
<p>Here is the fitted result:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot</span>(Estimate.logit ~<span class="st"> </span><span class="kw">abs</span>(Lat), d.survey)
<span class="kw">abline</span>(res.lat)</code></pre>
<div class="figure">
<img src="figure/survey_by_latidude.png" alt="Fitted latitude survey regression" /><p class="caption">Fitted latitude survey regression</p>
</div>
<p>As a categorical tropical/non-tropical variable:</p>
<pre class="sourceCode r"><code class="sourceCode r">res.tro &lt;-<span class="st"> </span><span class="kw">lm</span>(Estimate.logit ~<span class="st"> </span>Tropical, d.survey)
<span class="kw">anova</span>(res.tro)</code></pre>
<pre><code>## Analysis of Variance Table
## 
## Response: Estimate.logit
##            Df Sum Sq Mean Sq F value Pr(&gt;F)  
## Tropical    1    5.4    5.39    5.57  0.019 *
## Residuals 280  271.0    0.97                 
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">summary</span>(res.tro)</code></pre>
<pre><code>## 
## Call:
## lm(formula = Estimate.logit ~ Tropical, data = d.survey)
## 
## Residuals:
##    Min     1Q Median     3Q    Max 
## -3.883 -0.539  0.164  0.606  3.209 
## 
## Coefficients:
##              Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept)   -1.0116     0.0704  -14.36   &lt;2e-16 ***
## TropicalTRUE   0.2992     0.1268    2.36    0.019 *  
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 0.984 on 280 degrees of freedom
##   (10 observations deleted due to missingness)
## Multiple R-squared:  0.0195, Adjusted R-squared:  0.016 
## F-statistic: 5.57 on 1 and 280 DF,  p-value: 0.019</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">
fig.survey.results &lt;-<span class="st"> </span>function(d.survey, res.b, res.h) {
  ci &lt;-<span class="st"> </span><span class="dv">100</span>*<span class="kw">cbind</span>(res.b$overall.p, res.h$overall.p)
  cols &lt;-<span class="st"> </span>cols.methods
  cols.tr &lt;-<span class="st"> </span>diversitree:::<span class="kw">add.alpha</span>(cols, .<span class="dv">5</span>)

  op &lt;-<span class="st"> </span><span class="kw">par</span>(<span class="dt">no.readonly=</span><span class="ot">TRUE</span>)
  <span class="kw">on.exit</span>(<span class="kw">par</span>(op))

  <span class="kw">layout</span>(<span class="kw">rbind</span>(<span class="dv">1</span>:<span class="dv">2</span>), <span class="dt">widths=</span><span class="kw">c</span>(<span class="dv">4</span>, <span class="dv">5</span>))
  <span class="kw">par</span>(<span class="dt">mar=</span><span class="kw">c</span>(<span class="fl">6.5</span>, <span class="dv">2</span>, .<span class="dv">5</span>, .<span class="dv">5</span>), <span class="dt">oma=</span><span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">2</span>, <span class="dv">0</span>, <span class="dv">0</span>))
  <span class="kw">plot</span>(Estimate ~<span class="st"> </span>Familiarity, d.survey, <span class="dt">col=</span>cols.shading, <span class="dt">axes=</span><span class="ot">FALSE</span>,
       <span class="dt">xlab=</span><span class="st">&quot;&quot;</span>, <span class="dt">ylab=</span><span class="st">&quot;&quot;</span>, <span class="dt">bty=</span><span class="st">&quot;l&quot;</span>,
       <span class="dt">ylim=</span><span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">100</span>))
  <span class="kw">axis</span>(<span class="dv">2</span>, <span class="dt">las=</span><span class="dv">1</span>)
  <span class="kw">text</span>(<span class="dv">1</span>:<span class="dv">4</span>, -<span class="dv">5</span>, <span class="kw">levels</span>(d.survey$Familiarity),
       <span class="dt">srt=</span>-<span class="dv">55</span>, <span class="dt">xpd=</span><span class="ot">NA</span>, <span class="dt">adj=</span><span class="kw">c</span>(<span class="dv">0</span>, <span class="ot">NA</span>), <span class="dt">cex=</span>.<span class="dv">85</span>)
  <span class="kw">mtext</span>(<span class="st">&quot;Estimate of percentage woodiness&quot;</span>, <span class="dv">2</span>, <span class="dt">line=</span><span class="fl">2.75</span>)
  <span class="kw">label</span>(.<span class="dv">02</span>, .<span class="dv">96</span>, <span class="dv">1</span>)

  usr &lt;-<span class="st"> </span><span class="kw">par</span>(<span class="st">&quot;usr&quot;</span>)
  <span class="kw">rect</span>(usr[<span class="dv">1</span>], ci[<span class="st">&quot;lower&quot;</span>,], usr[<span class="dv">2</span>], ci[<span class="st">&quot;upper&quot;</span>,], <span class="dt">col=</span>cols.tr,
       <span class="dt">border=</span><span class="ot">NA</span>)
  <span class="kw">abline</span>(<span class="dt">h=</span>ci[<span class="st">&quot;mean&quot;</span>,], <span class="dt">col=</span>cols)

  <span class="kw">plot</span>(Estimate ~<span class="st"> </span>Training, d.survey, <span class="dt">col=</span>cols.shading, <span class="dt">axes=</span><span class="ot">FALSE</span>,
       <span class="dt">xlab=</span><span class="st">&quot;&quot;</span>, <span class="dt">ylab=</span><span class="st">&quot;&quot;</span>, <span class="dt">bty=</span><span class="st">&quot;l&quot;</span>, <span class="dt">ylim=</span><span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">100</span>))
  <span class="kw">axis</span>(<span class="dv">2</span>, <span class="dt">las=</span><span class="dv">1</span>)
  xl &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Postgrad&quot;</span>,<span class="st">&quot;Part postgrad&quot;</span>,<span class="st">&quot;Undergrad&quot;</span>,<span class="st">&quot;Part undergrad&quot;</span>, <span class="st">&quot;None&quot;</span>)
  <span class="kw">text</span>(<span class="dv">1</span>:<span class="dv">5</span>, -<span class="dv">5</span>, xl,
       <span class="dt">srt=</span>-<span class="dv">55</span>, <span class="dt">xpd=</span><span class="ot">TRUE</span>, <span class="dt">adj=</span><span class="kw">c</span>(<span class="dv">0</span>, <span class="ot">NA</span>), <span class="dt">cex=</span>.<span class="dv">85</span>) 
  <span class="kw">label</span>(.<span class="dv">02</span>, .<span class="dv">96</span>, <span class="dv">2</span>) 

  usr &lt;-<span class="st"> </span><span class="kw">par</span>(<span class="st">&quot;usr&quot;</span>)
  <span class="kw">rect</span>(usr[<span class="dv">1</span>], ci[<span class="st">&quot;lower&quot;</span>,], usr[<span class="dv">2</span>], ci[<span class="st">&quot;upper&quot;</span>,], <span class="dt">col=</span>cols.tr,
       <span class="dt">border=</span><span class="ot">NA</span>)
  <span class="kw">abline</span>(<span class="dt">h=</span>ci[<span class="st">&quot;mean&quot;</span>,], <span class="dt">col=</span>cols)
}</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">fig.survey.results</span>(d.survey, res.b, res.h)</code></pre>
<div class="figure">
<img src="figure/survey_results.png" alt="Survey results by predictor" /><p class="caption">Survey results by predictor</p>
</div>
<pre class="sourceCode r"><code class="sourceCode r">
fig.survey.distribution &lt;-<span class="st"> </span>function(d.survey, res.b, res.h) {
  op &lt;-<span class="st"> </span><span class="kw">par</span>(<span class="dt">mfrow=</span><span class="kw">c</span>(<span class="dv">2</span>, <span class="dv">1</span>), <span class="dt">mar=</span><span class="kw">c</span>(<span class="dv">2</span>, <span class="dv">4</span>, .<span class="dv">5</span>, .<span class="dv">5</span>), <span class="dt">oma=</span><span class="kw">c</span>(<span class="dv">2</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>))
  <span class="kw">on.exit</span>(<span class="kw">par</span>(op))
  lwd &lt;-<span class="st"> </span><span class="fl">1.5</span>

  ci &lt;-<span class="st"> </span><span class="dv">100</span>*<span class="kw">cbind</span>(res.b$overall.p, res.h$overall.p)
  <span class="kw">hist</span>(d.survey$Estimate, <span class="dt">xlim=</span><span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">100</span>), <span class="dt">las=</span><span class="dv">1</span>, <span class="dt">col=</span>cols.shading,
       <span class="dt">xaxt=</span><span class="st">&quot;n&quot;</span>, <span class="dt">xlab=</span><span class="st">&quot;&quot;</span>, <span class="dt">ylab=</span><span class="st">&quot;Number of responses&quot;</span>, <span class="dt">main=</span><span class="st">&quot;&quot;</span>)
  <span class="kw">box</span>(<span class="dt">bty=</span><span class="st">&quot;l&quot;</span>)
  <span class="kw">axis</span>(<span class="dv">1</span>, <span class="dt">label=</span><span class="ot">FALSE</span>)
  <span class="kw">label</span>(.<span class="dv">02</span>, .<span class="dv">96</span>, <span class="dv">1</span>)

  usr &lt;-<span class="st"> </span><span class="kw">par</span>(<span class="st">&quot;usr&quot;</span>)
  <span class="kw">rect</span>(ci[<span class="st">&quot;lower&quot;</span>,], usr[<span class="dv">3</span>], ci[<span class="st">&quot;upper&quot;</span>,], usr[<span class="dv">4</span>],
       <span class="dt">col=</span>diversitree:::<span class="kw">add.alpha</span>(cols.methods, .<span class="dv">5</span>), <span class="dt">border=</span><span class="ot">NA</span>)
  <span class="kw">abline</span>(<span class="dt">v=</span>ci[<span class="st">&quot;mean&quot;</span>,], <span class="dt">col=</span>cols.methods)

  h.tropical &lt;-<span class="st"> </span><span class="kw">hist</span>(d.survey$Estimate[d.survey$Tropical], <span class="dt">plot=</span><span class="ot">FALSE</span>)
  h.temperate &lt;-<span class="st"> </span><span class="kw">hist</span>(d.survey$Estimate[!d.survey$Tropical], <span class="dt">plot=</span><span class="ot">FALSE</span>)

  ylim &lt;-<span class="st"> </span><span class="kw">range</span>(h.tropical$counts, h.temperate$counts)
  <span class="kw">plot</span>(<span class="ot">NA</span>, <span class="dt">xlim=</span><span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">100</span>), <span class="dt">ylim=</span>ylim, <span class="dt">las=</span><span class="dv">1</span>, <span class="dt">xlab=</span><span class="st">&quot;&quot;</span>,
       <span class="dt">ylab=</span><span class="st">&quot;Number of responses&quot;</span>, <span class="dt">bty=</span><span class="st">&quot;n&quot;</span>, <span class="dt">bty=</span><span class="st">&quot;l&quot;</span>)
  <span class="kw">mtext</span>(<span class="st">&quot;Estimate of percentage woodiness&quot;</span>, <span class="dv">1</span>, <span class="dt">outer=</span><span class="ot">TRUE</span>, <span class="dt">line=</span>.<span class="dv">5</span>)

  <span class="kw">hist.outline</span>(h.tropical,  <span class="dt">col=</span>cols.tropical[<span class="dv">1</span>], <span class="dt">lwd=</span>lwd, <span class="dt">density=</span><span class="ot">FALSE</span>)
  <span class="kw">hist.outline</span>(h.temperate, <span class="dt">col=</span>cols.tropical[<span class="dv">2</span>], <span class="dt">lwd=</span>lwd, <span class="dt">density=</span><span class="ot">FALSE</span>)

  usr &lt;-<span class="st"> </span><span class="kw">par</span>(<span class="st">&quot;usr&quot;</span>)
  <span class="kw">rect</span>(ci[<span class="st">&quot;lower&quot;</span>,], usr[<span class="dv">3</span>], ci[<span class="st">&quot;upper&quot;</span>,], usr[<span class="dv">4</span>],
       <span class="dt">col=</span>diversitree:::<span class="kw">add.alpha</span>(cols.methods, .<span class="dv">5</span>), <span class="dt">border=</span><span class="ot">NA</span>)
  <span class="kw">abline</span>(<span class="dt">v=</span>ci[<span class="st">&quot;mean&quot;</span>,], <span class="dt">col=</span>cols.methods)

  <span class="kw">label</span>(.<span class="dv">02</span>, .<span class="dv">96</span>, <span class="dv">2</span>)

  <span class="kw">legend</span>(<span class="st">&quot;topright&quot;</span>, <span class="kw">c</span>(<span class="st">&quot;Tropical&quot;</span>, <span class="st">&quot;Temperate&quot;</span>), <span class="dt">lwd=</span>lwd,
         <span class="dt">col=</span>cols.tropical, <span class="dt">bty=</span><span class="st">&quot;n&quot;</span>, <span class="dt">cex=</span>.<span class="dv">75</span>)
}</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">fig.survey.distribution</span>(d.survey, res.b, res.h)</code></pre>
<div class="figure">
<img src="figure/survey_distribution.png" alt="Distribution of survey results" /><p class="caption">Distribution of survey results</p>
</div>
<pre class="sourceCode r"><code class="sourceCode r">
fig.variability &lt;-<span class="st"> </span>function(dat.g) {
  dat.g$p.rare &lt;-<span class="st"> </span>(<span class="fl">0.5</span> -<span class="st"> </span><span class="kw">abs</span>(dat.g$p -<span class="st"> </span><span class="dv">1</span>/<span class="dv">2</span>)) *<span class="st"> </span><span class="dv">2</span>
  dat.g$variable &lt;-<span class="st"> </span>dat.g$p.rare &gt;<span class="st"> </span><span class="dv">0</span>

  sub &lt;-<span class="st"> </span>dat.g[!<span class="kw">is.nan</span>(dat.g$p),]

  ## Breaks for the moving average:
  br.N &lt;-<span class="st"> </span><span class="kw">log.seq.range</span>(sub$N, <span class="dv">20</span>)
  br.K &lt;-<span class="st"> </span><span class="kw">log.seq.range</span>(sub$K, <span class="dv">15</span>)

  ## Classify points:
  i.N &lt;-<span class="st"> </span><span class="kw">findInterval</span>(sub$N, br.N, <span class="dt">all.inside=</span><span class="ot">TRUE</span>)  
  i.K &lt;-<span class="st"> </span><span class="kw">findInterval</span>(sub$K, br.K, <span class="dt">all.inside=</span><span class="ot">TRUE</span>)  

  ## Midpoints for plotting.
  mid.N &lt;-<span class="st"> </span>(br.N[-<span class="dv">1</span>] +<span class="st"> </span>br.N[-<span class="kw">length</span>(br.N)])/<span class="dv">2</span>
  mid.K &lt;-<span class="st"> </span>(br.K[-<span class="dv">1</span>] +<span class="st"> </span>br.K[-<span class="kw">length</span>(br.K)])/<span class="dv">2</span>

  m.N &lt;-<span class="st"> </span><span class="kw">tapply</span>(sub$p.rare, i.N, mean)
  m.K &lt;-<span class="st"> </span><span class="kw">tapply</span>(sub$p.rare, i.K, mean)
  p.N &lt;-<span class="st"> </span><span class="kw">tapply</span>(sub$variable, i.N, mean)
  p.K &lt;-<span class="st"> </span><span class="kw">tapply</span>(sub$variable, i.K, mean)
  f.N &lt;-<span class="st"> </span><span class="kw">tapply</span>(sub$p, i.N, mean)
  f.K &lt;-<span class="st"> </span><span class="kw">tapply</span>(sub$p, i.K, mean)

  pch &lt;-<span class="st"> </span><span class="dv">19</span>
  cex &lt;-<span class="st"> </span><span class="fl">0.5</span>
  col &lt;-<span class="st"> &quot;#00000066&quot;</span>

  op &lt;-<span class="st"> </span><span class="kw">par</span>(<span class="dt">oma=</span><span class="kw">c</span>(<span class="fl">4.1</span>, <span class="fl">4.1</span>, <span class="dv">0</span>, <span class="dv">0</span>),
            <span class="dt">mar=</span><span class="kw">c</span>(<span class="fl">1.1</span>, <span class="fl">1.1</span>, .<span class="dv">5</span>, .<span class="dv">5</span>),
            <span class="dt">mfrow=</span><span class="kw">c</span>(<span class="dv">3</span>, <span class="dv">2</span>))
  
  <span class="kw">plot</span>(p.rare ~<span class="st"> </span>N, sub, <span class="dt">pch=</span>pch, <span class="dt">cex=</span>cex, <span class="dt">col=</span>col, <span class="dt">log=</span><span class="st">&quot;x&quot;</span>,
       <span class="dt">axes=</span><span class="ot">FALSE</span>)
  <span class="kw">lines</span>(m.N ~<span class="st"> </span>mid.N, <span class="dt">col=</span><span class="st">&quot;red&quot;</span>)
  <span class="kw">axis</span>(<span class="dv">1</span>, <span class="dt">labels=</span><span class="ot">FALSE</span>) 
  <span class="kw">axis</span>(<span class="dv">2</span>, <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="kw">c</span>(<span class="st">&quot;Single type&quot;</span>, <span class="st">&quot;50:50&quot;</span>), <span class="dt">las=</span><span class="dv">1</span>)
  <span class="kw">mtext</span>(<span class="st">&quot;Variability&quot;</span>, <span class="dv">2</span>, <span class="dv">3</span>)
  <span class="kw">box</span>(<span class="dt">bty=</span><span class="st">&quot;l&quot;</span>)
  <span class="kw">label</span>(.<span class="dv">02</span>, .<span class="dv">96</span>, <span class="dv">1</span>)

  <span class="kw">plot</span>(p.rare ~<span class="st"> </span>K, sub, <span class="dt">pch=</span>pch, <span class="dt">cex=</span>cex, <span class="dt">col=</span>col, <span class="dt">log=</span><span class="st">&quot;x&quot;</span>,
       <span class="dt">axes=</span><span class="ot">FALSE</span>)
  <span class="kw">lines</span>(m.K ~<span class="st"> </span>mid.K, <span class="dt">col=</span><span class="st">&quot;red&quot;</span>)
  <span class="kw">axis</span>(<span class="dv">1</span>, <span class="dt">labels=</span><span class="ot">FALSE</span>) 
  <span class="kw">axis</span>(<span class="dv">2</span>, <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="dt">labels=</span><span class="ot">FALSE</span>)
  <span class="kw">box</span>(<span class="dt">bty=</span><span class="st">&quot;l&quot;</span>)
  <span class="kw">label</span>(.<span class="dv">02</span>, .<span class="dv">96</span>, <span class="dv">2</span>)

  <span class="kw">plot</span>(variable ~<span class="st"> </span>N, sub, <span class="dt">pch=</span>pch, <span class="dt">cex=</span>cex, <span class="dt">col=</span>col, <span class="dt">log=</span><span class="st">&quot;x&quot;</span>,
       <span class="dt">bty=</span><span class="st">&quot;l&quot;</span>, <span class="dt">las=</span><span class="dv">1</span>, <span class="dt">axes=</span><span class="ot">FALSE</span>)
  <span class="kw">lines</span>(p.N ~<span class="st"> </span>mid.N, <span class="dt">col=</span><span class="st">&quot;red&quot;</span>)
  <span class="kw">axis</span>(<span class="dv">1</span>, <span class="dt">labels=</span><span class="ot">FALSE</span>)
  <span class="kw">axis</span>(<span class="dv">2</span>, <span class="dt">las=</span><span class="dv">1</span>)
  <span class="kw">mtext</span>(<span class="st">&quot;Probability genus is variable&quot;</span>, <span class="dv">2</span>, <span class="dv">3</span>) 
  <span class="kw">box</span>(<span class="dt">bty=</span><span class="st">&quot;l&quot;</span>) 
  <span class="kw">label</span>(.<span class="dv">02</span>, .<span class="dv">96</span>, <span class="dv">3</span>)

  <span class="kw">plot</span>(variable ~<span class="st"> </span>K, sub, <span class="dt">pch=</span>pch, <span class="dt">cex=</span>cex, <span class="dt">col=</span>col, <span class="dt">log=</span><span class="st">&quot;x&quot;</span>,
       <span class="dt">bty=</span><span class="st">&quot;l&quot;</span>, <span class="dt">yaxt=</span><span class="st">&quot;n&quot;</span>, <span class="dt">las=</span><span class="dv">1</span>, <span class="dt">axes=</span><span class="ot">FALSE</span>)
  <span class="kw">lines</span>(p.K ~<span class="st"> </span>mid.K, <span class="dt">col=</span><span class="st">&quot;red&quot;</span>)
  <span class="kw">axis</span>(<span class="dv">1</span>, <span class="dt">labels=</span><span class="ot">FALSE</span>)
  <span class="kw">axis</span>(<span class="dv">2</span>, <span class="dt">labels=</span><span class="ot">FALSE</span>) 
  <span class="kw">box</span>(<span class="dt">bty=</span><span class="st">&quot;l&quot;</span>) 
  <span class="kw">label</span>(.<span class="dv">02</span>, .<span class="dv">96</span>, <span class="dv">4</span>)

  <span class="kw">plot</span>(p ~<span class="st"> </span>N, sub, <span class="dt">pch=</span>pch, <span class="dt">cex=</span>cex, <span class="dt">col=</span>col, <span class="dt">log=</span><span class="st">&quot;x&quot;</span>,
       <span class="dt">bty=</span><span class="st">&quot;l&quot;</span>, <span class="dt">las=</span><span class="dv">1</span>)
  <span class="kw">lines</span>(f.N ~<span class="st"> </span>mid.N, <span class="dt">col=</span><span class="st">&quot;red&quot;</span>)
  <span class="kw">mtext</span>(<span class="st">&quot;Number of species in genus&quot;</span>, <span class="dv">1</span>, <span class="dv">3</span>)
  <span class="kw">mtext</span>(<span class="st">&quot;Proportion of species woody&quot;</span>, <span class="dv">2</span>, <span class="dv">3</span>)
  <span class="kw">label</span>(.<span class="dv">02</span>, .<span class="dv">96</span>, <span class="dv">5</span>)

  <span class="kw">plot</span>(p ~<span class="st"> </span>K, sub, <span class="dt">pch=</span>pch, <span class="dt">cex=</span>cex, <span class="dt">col=</span>col, <span class="dt">log=</span><span class="st">&quot;x&quot;</span>,
       <span class="dt">bty=</span><span class="st">&quot;l&quot;</span>, <span class="dt">yaxt=</span><span class="st">&quot;n&quot;</span>, <span class="dt">las=</span><span class="dv">1</span>)
  <span class="kw">lines</span>(f.K ~<span class="st"> </span>mid.K, <span class="dt">col=</span><span class="st">&quot;red&quot;</span>)
  <span class="kw">axis</span>(<span class="dv">2</span>, <span class="dt">labels=</span><span class="ot">FALSE</span>)
  <span class="kw">mtext</span>(<span class="st">&quot;Number of species with known state&quot;</span>, <span class="dv">1</span>, <span class="dv">3</span>)
  <span class="kw">label</span>(.<span class="dv">02</span>, .<span class="dv">96</span>, <span class="dv">6</span>)
}</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">fig.variability</span>(dat.g)</code></pre>
<div class="figure">
<img src="figure/variability.png" alt="Variability by genus size" /><p class="caption">Variability by genus size</p>
</div>
<p>Export tables</p>
<pre class="sourceCode r"><code class="sourceCode r">write.output &lt;-<span class="st"> </span>function(d, type) {
  for (tax in <span class="kw">c</span>(<span class="st">&quot;genus&quot;</span>, <span class="st">&quot;family&quot;</span>, <span class="st">&quot;order&quot;</span>))
    <span class="kw">write.csv</span>(d[[tax]],
              <span class="kw">file.path</span>(<span class="st">&quot;output&quot;</span>, <span class="kw">sprintf</span>(<span class="st">&quot;%s-%s.csv&quot;</span>, tax, type)),
              <span class="dt">row.names=</span><span class="ot">FALSE</span>)
}</code></pre>
<p>Core data sets:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">write.output</span>(res.b, <span class="st">&quot;binomial-strong-prior&quot;</span>)
<span class="kw">write.output</span>(res.h, <span class="st">&quot;hypergeometric-weak-prior&quot;</span>)</code></pre>
<p>Extra data sets:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">write.output</span>(res.b.w, <span class="st">&quot;binomial-strong-prior-wood-biased&quot;</span>)
<span class="kw">write.output</span>(res.h.w, <span class="st">&quot;hypergeometric-weak-prior-wood-biased&quot;</span>)
<span class="kw">write.output</span>(res.b.h, <span class="st">&quot;binomial-strong-prior-herb-biased&quot;</span>)
<span class="kw">write.output</span>(res.h.h, <span class="st">&quot;hypergeometric-weak-prior-herb-biased&quot;</span>)</code></pre>
<p>Meta data:</p>
<pre class="sourceCode r"><code class="sourceCode r">metadata &lt;-<span class="st"> </span>
<span class="st">  </span><span class="kw">list</span>(<span class="dt">order=</span><span class="st">&quot;Taxonomic order&quot;</span>,
       <span class="dt">family=</span><span class="st">&quot;Taxonomic family&quot;</span>,
       <span class="dt">genus=</span><span class="st">&quot;Taxonomic genus&quot;</span>,
       <span class="dt">W=</span><span class="st">&quot;Number of species known to be woody&quot;</span>,
       <span class="dt">V=</span><span class="st">&quot;Number of species known to be variable&quot;</span>,
       <span class="dt">H=</span><span class="st">&quot;Number of species known to be herbaceous&quot;</span>,
       <span class="dt">N=</span><span class="st">&quot;Estimate of the number of species in the genus/family/order&quot;</span>,
       <span class="dt">K=</span><span class="st">&quot;Number of species with known state (W + H)&quot;</span>,
       <span class="dt">mean=</span><span class="st">&quot;Mean estimated number of woody species&quot;</span>,
       <span class="dt">lower=</span><span class="st">&quot;0.025 quantile of estimated number of woody species&quot;</span>,
       <span class="dt">upper=</span><span class="st">&quot;0.975 quantile of estimated number of woody species&quot;</span>,
       <span class="dt">p.mean=</span><span class="st">&quot;Mean estimated fration of woody species&quot;</span>,
       <span class="dt">p.lower=</span><span class="st">&quot;0.025 quantile of estimated fraction of woody species&quot;</span>,
       <span class="dt">p.upper=</span><span class="st">&quot;0.975 quantile of estimated fraction of woody species&quot;</span>)
metadata &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">column=</span><span class="kw">names</span>(metadata),
                       <span class="dt">description=</span><span class="kw">unlist</span>(metadata),
                       <span class="dt">stringsAsFactors=</span><span class="ot">FALSE</span>)
<span class="kw">write.csv</span>(metadata, <span class="st">&quot;output/metadata.csv&quot;</span>, <span class="dt">row.names=</span><span class="ot">FALSE</span>)</code></pre>
<p>Produce versions for publication:</p>
<pre class="sourceCode r"><code class="sourceCode r">if (!<span class="kw">interactive</span>()) {
  <span class="kw">to.pdf</span>(<span class="st">&quot;doc/figs/fraction-by-genus.pdf&quot;</span>, <span class="dv">6</span>, <span class="dv">6</span>,
         <span class="kw">fig.fraction.by.group</span>(res.b, res.h, dat.g, <span class="st">&quot;genus&quot;</span>))
  <span class="kw">to.pdf</span>(<span class="st">&quot;doc/figs/fraction-by-family.pdf&quot;</span>, <span class="dv">6</span>, <span class="dv">6</span>,
         <span class="kw">fig.fraction.by.group</span>(res.b, res.h, dat.g, <span class="st">&quot;family&quot;</span>))
  <span class="kw">to.pdf</span>(<span class="st">&quot;doc/figs/fraction-by-order.pdf&quot;</span>, <span class="dv">6</span>, <span class="dv">6</span>,
         <span class="kw">fig.fraction.by.group</span>(res.b, res.h, dat.g, <span class="st">&quot;order&quot;</span>))

  <span class="kw">to.pdf</span>(<span class="st">&quot;doc/figs/fraction-on-phylogeny.pdf&quot;</span>, <span class="dv">6</span>, <span class="dv">6</span>,
         <span class="kw">fig.fraction.on.phylogeny</span>(phy.o, res.b))

  <span class="kw">to.pdf</span>(<span class="st">&quot;doc/figs/fraction-on-phylogeny-supp.pdf&quot;</span>, <span class="dv">6</span>, <span class="dv">6</span>,
         <span class="kw">fig.fraction.on.phylogeny</span>(phy.o, res.h))

  <span class="kw">to.pdf</span>(<span class="st">&quot;doc/figs/distribution-raw.pdf&quot;</span>, <span class="dv">6</span>, <span class="dv">4</span>,
         <span class="kw">fig.distribution.raw</span>(res.b, res.h))
  <span class="kw">to.pdf</span>(<span class="st">&quot;doc/figs/distribution-raw-errors.pdf&quot;</span>, <span class="dv">6</span>, <span class="dv">4</span>,
         <span class="kw">fig.distribution.raw.errors</span>(res.b, res.h, res.b.w, res.h.w,
                                     res.b.h, res.h.h))

  <span class="kw">to.pdf</span>(<span class="st">&quot;doc/figs/survey-results.pdf&quot;</span>, <span class="dv">6</span>, <span class="dv">4</span>,
         <span class="kw">fig.survey.results</span>(d.survey, res.b, res.h))

  <span class="kw">to.pdf</span>(<span class="st">&quot;doc/figs/survey-distribution.pdf&quot;</span>, <span class="dv">6</span>, <span class="dv">5</span>,
         <span class="kw">fig.survey.distribution</span>(d.survey, res.b, res.h))

  <span class="kw">to.pdf</span>(<span class="st">&quot;doc/figs/variability.pdf&quot;</span>, <span class="dv">7</span>, <span class="dv">8</span>,
         <span class="kw">fig.variability</span>(dat.g))
}</code></pre>
<pre><code>## Creating doc/figs/fraction-by-genus.pdf</code></pre>
<pre><code>## Creating doc/figs/fraction-by-family.pdf</code></pre>
<pre><code>## Creating doc/figs/fraction-by-order.pdf</code></pre>
<pre><code>## Creating doc/figs/fraction-on-phylogeny.pdf</code></pre>
<pre><code>## Creating doc/figs/fraction-on-phylogeny-supp.pdf</code></pre>
<pre><code>## Creating doc/figs/distribution-raw.pdf</code></pre>
<pre><code>## Creating doc/figs/distribution-raw-errors.pdf</code></pre>
<pre><code>## Creating doc/figs/survey-results.pdf</code></pre>
<pre><code>## Creating doc/figs/survey-distribution.pdf</code></pre>
<pre><code>## Creating doc/figs/variability.pdf</code></pre>
</body>
</html>
